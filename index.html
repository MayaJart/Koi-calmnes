<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Koi Pond</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: #083d52;
  }
  canvas { display: block; }
  #warning {
    position: fixed;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    color: #fff;
    font-family: sans-serif;
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 14px;
    z-index: 10;
    max-width: 90vw;
    text-align: center;
    display: none;
  }
  #warning button {
    margin-top: 8px;
    padding: 6px 10px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
</style>
</head>
<body>
<div id="warning"></div>
<canvas id="pond"></canvas>

<script>
/* ================= BASIC SETUP ================= */
const canvas = document.getElementById('pond');
const ctx = canvas.getContext('2d');
const warningEl = document.getElementById('warning');

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

/* ================= WATER ================= */
let lightOffset = 0;
function drawWater() {
  const g = ctx.createLinearGradient(0, 0, 0, canvas.height);
  g.addColorStop(0, '#1fbad6');
  g.addColorStop(1, '#0b5c7a');
  ctx.fillStyle = g;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  ctx.globalAlpha = 0.25;
  ctx.globalCompositeOperation = 'screen';
  lightOffset += 0.15;

  for (let x = -200; x < canvas.width + 200; x += 200) {
    for (let y = -200; y < canvas.height + 200; y += 200) {
      ctx.beginPath();
      ctx.arc(x + (lightOffset % 200), y + (lightOffset % 200), 90, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(255,255,255,0.08)';
      ctx.fill();
    }
  }

  ctx.globalCompositeOperation = 'source-over';
  ctx.globalAlpha = 1;
}

/* ================= RIPPLE SYSTEM ================= */
const ripples = [];
canvas.addEventListener('pointerdown', e => {
  ripples.push({ x: e.clientX, y: e.clientY, r: 0, a: 0.4 });
});

function drawRipples() {
  for (let i = ripples.length - 1; i >= 0; i--) {
    const r = ripples[i];
    r.r += 2.4;
    r.a -= 0.01;
    if (r.a <= 0) {
      ripples.splice(i, 1);
      continue;
    }
    ctx.beginPath();
    ctx.arc(r.x, r.y, r.r, 0, Math.PI * 2);
    ctx.strokeStyle = `rgba(255,255,255,${r.a})`;
    ctx.lineWidth = 2;
    ctx.stroke();
  }
}

/* ================= KOI IMAGE LOADING ================= */
// Images must be in the SAME folder as index.html
const koiImageNames = [
  'default-koi1.png','default-koi2.png','default-koi3.png','default-koi4.png','default-koi5.png',
  'forehead-spot-koi1.png','forehead-spot-koi2.png',
  'scatter-pattern1.png','scatter-pattern2.png','scatter-pattern3.png'
];

const koiImages = [];
let imagesLoaded = 0;
let imagesFailed = 0;

function loadImages(onComplete) {
  koiImageNames.forEach(name => {
    const img = new Image();

    img.onload = () => {
      imagesLoaded++;
      checkDone(onComplete);
    };

    img.onerror = () => {
      imagesFailed++;
      console.error('Failed to load image:', name);
      checkDone(onComplete);
    };

    img.src = name;
    koiImages.push(img);
  });
}

function checkDone(onComplete) {
  if (imagesLoaded + imagesFailed === koiImageNames.length) {
    console.assert(imagesLoaded + imagesFailed === koiImageNames.length, 'All image attempts finished');

    if (imagesLoaded === 0) {
      warningEl.style.display = 'block';
      warningEl.innerHTML = `
        <strong>No koi images loaded.</strong><br>
        Make sure the image filenames exactly match (case-sensitive) and then refresh.<br>
        <button onclick="location.reload()">Refresh page</button>
      `;
    }

    onComplete();
  }
}

function randomKoiImage() {
  const valid = koiImages.filter(img => img.complete && img.naturalWidth > 0);
  if (valid.length === 0) return null;
  return valid[Math.floor(Math.random() * valid.length)];
}

/* ================= KOI CREATION ================= */
function createKoi() {
  return {
    img: randomKoiImage(),
    x: Math.random() * canvas.width,
    y: Math.random() * canvas.height,
    angle: Math.random() * Math.PI * 2,
    speed: 0.25 + Math.random() * 0.25,
    size: 0.6 + Math.random() * 0.5,
    wiggle: Math.random() * Math.PI * 2
  };
}

let koiFish = [];

/* ================= DRAW KOI ================= */
function drawKoi(k) {
  k.wiggle += 0.08;
  const tailWiggle = Math.sin(k.wiggle) * 0.15;

  k.x += Math.cos(k.angle) * k.speed;
  k.y += Math.sin(k.angle) * k.speed;
  k.angle += tailWiggle * 0.02;

  if (k.x < -100) k.x = canvas.width + 100;
  if (k.x > canvas.width + 100) k.x = -100;
  if (k.y < -100) k.y = canvas.height + 100;
  if (k.y > canvas.height + 100) k.y = -100;

  ctx.save();
  ctx.translate(k.x, k.y);
  ctx.rotate(k.angle);
  ctx.scale(k.size, k.size);

  if (k.img) {
    ctx.drawImage(k.img, -80, -40, 160, 80);
  } else {
    // Placeholder koi so the pond is never empty
    ctx.fillStyle = 'rgba(255,255,255,0.85)';
    ctx.beginPath();
    ctx.ellipse(0, 0, 60, 25, 0, 0, Math.PI * 2);
    ctx.fill();
  }

  ctx.restore();
}

/* ================= MAIN LOOP ================= */
function loop() {
  drawWater();
  koiFish.forEach(drawKoi);
  drawRipples();
  requestAnimationFrame(loop);
}

/* ================= START ================= */
loadImages(() => {
  koiFish = Array.from({ length: 12 }, createKoi);
  console.assert(koiFish.length === 12, 'Correct number of koi created');
  loop();
});
</script>
</body>
</html>
